<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proof of Packaging - ClavaStack</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="dist/output.css">
    <script src="https://opentimestamps.org/assets/javascripts/vendor/opentimestamps.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="text-specter-text">
    <!-- Header -->
    <header class="border-b border-specter-border bg-specter-darker/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="assets/logos/ClavaStack.png" alt="ClavaStack" class="h-10 w-auto" onerror="this.style.display='none'">
                    <span class="text-xl font-bold">ClavaStack <span class="text-specter-cyan">Proof</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Language Switcher -->
                    <div class="relative">
                        <button onclick="toggleLanguageMenu()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-specter-card border border-specter-border hover:border-specter-cyan transition">
                            <img id="currentFlag" src="assets/flags/en.svg" alt="EN" class="w-5 h-4 rounded-sm object-cover">
                            <span id="currentLang" class="text-sm font-medium">EN</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="languageMenu" class="hidden absolute right-0 mt-2 w-40 bg-specter-card border border-specter-border rounded-lg shadow-xl overflow-hidden">
                            <button onclick="setLanguage('en')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-specter-border transition text-left">
                                <img src="assets/flags/en.svg" alt="EN" class="w-5 h-4 rounded-sm object-cover">
                                <span>English</span>
                            </button>
                            <button onclick="setLanguage('de')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-specter-border transition text-left">
                                <img src="assets/flags/de.svg" alt="DE" class="w-5 h-4 rounded-sm object-cover">
                                <span>Deutsch</span>
                            </button>
                        </div>
                    </div>
                    <!-- Add New Button -->
                    <a href="/add/" class="px-4 py-2 bg-specter-cyan text-specter-darker font-semibold rounded-lg hover:bg-specter-cyanDark transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span data-i18n="addNew">Add New</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="py-16 sm:py-24 px-4">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-6">
                <span class="text-white">Specter Hardware Wallets</span><br>
                <span class="gradient-text" data-i18n="heroSubtitle">packaged by ClavaStack</span>
            </h1>
            <p class="text-2xl sm:text-3xl font-semibold text-specter-cyan mb-8" data-i18n="heroSlogan">
                Trust the Source, Not the Route
            </p>
            <p class="text-lg text-specter-textMuted max-w-2xl mx-auto" data-i18n="heroDescription">
                Every Specter Hardware Wallet packaged by ClavaStack is cryptographically timestamped on the Bitcoin blockchain.
                This provides immutable proof of packaging integrity that can be independently verified by anyone.
            </p>
        </div>
    </section>

    <!-- Suppliers Section -->
    <section class="py-12 px-4 border-t border-specter-border">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-8" data-i18n="suppliersTitle">Official Suppliers</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" id="suppliersGrid">
                <!-- Suppliers will be rendered here -->
            </div>
        </div>
    </section>

    <!-- Proof Table Section -->
    <section class="py-12 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="bg-specter-card border border-specter-border rounded-2xl overflow-hidden">
                <div class="p-6 border-b border-specter-border">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold" data-i18n="proofTableTitle">Verified Packaging Proofs</h2>
                            <p class="text-specter-textMuted mt-1" data-i18n="proofTableSubtitle">All packages with Bitcoin blockchain timestamps</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <select id="sortSelect" class="bg-specter-dark border border-specter-border rounded-lg px-4 py-2 text-sm focus:border-specter-cyan focus:outline-none">
                                <option value="date-desc" data-i18n="sortNewest">Newest first</option>
                                <option value="date-asc" data-i18n="sortOldest">Oldest first</option>
                                <option value="bagId-asc" data-i18n="sortBagIdAsc">Bag ID (asc)</option>
                                <option value="bagId-desc" data-i18n="sortBagIdDesc">Bag ID (desc)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-specter-darker">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-specter-textMuted uppercase tracking-wider" data-i18n="colBagId">Bag ID</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-specter-textMuted uppercase tracking-wider" data-i18n="colDate">Date</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-specter-textMuted uppercase tracking-wider" data-i18n="colVersion">Version</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-specter-textMuted uppercase tracking-wider" data-i18n="colPacker">Packer</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-specter-textMuted uppercase tracking-wider" data-i18n="colProof">Blockchain Proof</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-specter-textMuted uppercase tracking-wider" data-i18n="colImage">Image</th>
                            </tr>
                        </thead>
                        <tbody id="proofsTableBody" class="divide-y divide-specter-border">
                            <!-- Proofs will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="hidden py-16 text-center">
                    <svg class="w-16 h-16 mx-auto text-specter-textMuted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-2" data-i18n="emptyTitle">No proofs yet</h3>
                    <p class="text-specter-textMuted mb-4" data-i18n="emptyDescription">Start by adding your first packaging proof.</p>
                    <a href="/add/" class="inline-flex items-center gap-2 px-6 py-3 bg-specter-cyan text-specter-darker font-semibold rounded-lg hover:bg-specter-cyanDark transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span data-i18n="addFirstProof">Add First Proof</span>
                    </a>
                </div>
            </div>

            <!-- CSV Export -->
            <div class="mt-6 flex justify-end">
                <button onclick="exportCSV()" class="flex items-center gap-2 px-4 py-2 bg-specter-card border border-specter-border rounded-lg hover:border-specter-cyan transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span data-i18n="exportCSV">Export as CSV</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Timestamp Proof Modal -->
    <div id="timestampModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-specter-card border border-specter-border rounded-2xl shadow-2xl max-w-lg mx-4 p-6 w-full">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-xl font-bold" data-i18n="modalTitle">Blockchain Timestamp Proof</h3>
                <button onclick="closeTimestampModal()" class="text-specter-textMuted hover:text-white text-2xl">&times;</button>
            </div>

            <div id="timestampVerified" class="hidden mb-6 p-4 bg-specter-success/10 border border-specter-success/30 rounded-xl">
                <div class="flex items-center gap-2 text-specter-success font-semibold mb-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span data-i18n="verifiedTitle">Verified on Bitcoin Blockchain</span>
                </div>
                <p class="text-sm text-specter-success/80" data-i18n="verifiedDescription">This record was provably created before the stated time.</p>
            </div>

            <div id="timestampPending" class="hidden mb-6 p-4 bg-specter-warning/10 border border-specter-warning/30 rounded-xl">
                <div class="flex items-center gap-2 text-specter-warning font-semibold mb-2">
                    <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span data-i18n="pendingTitle">Awaiting Bitcoin Blockchain</span>
                </div>
                <p class="text-sm text-specter-warning/80" data-i18n="pendingDescription">Timestamp sent to calendar servers, waiting for Bitcoin block confirmation (few hours).</p>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalBagId">Bag ID:</span>
                    <span id="tsModalBagId" class="font-mono text-white"></span>
                </div>
                <div class="flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalHash">SHA-256 Hash:</span>
                    <span id="tsModalHash" class="font-mono text-xs text-white break-all max-w-[200px]"></span>
                </div>
                <div id="tsBlockHeightRow" class="hidden flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalBlock">Bitcoin Block:</span>
                    <a id="tsModalBlockHeight" href="#" target="_blank" class="font-mono text-specter-cyan hover:underline"></a>
                </div>
                <div id="tsBlockTimeRow" class="hidden flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalBlockTime">Block Time:</span>
                    <span id="tsModalBlockTime" class="text-white"></span>
                </div>
                <div class="flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalCreated">Created:</span>
                    <span id="tsModalCreated" class="text-white"></span>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button id="downloadOtsButton" onclick="downloadOtsFile()" class="flex-1 px-4 py-3 bg-specter-cyan text-specter-darker font-semibold rounded-lg hover:bg-specter-cyanDark transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span data-i18n="downloadOts">Download .ots</span>
                </button>
                <button onclick="verifyExternal()" class="flex-1 px-4 py-3 bg-specter-dark border border-specter-border text-white font-semibold rounded-lg hover:border-specter-cyan transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    <span data-i18n="verifyExternal">Verify Externally</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="relative max-w-4xl w-full">
            <button onclick="closeImageModal()" class="absolute -top-12 right-0 text-white hover:text-specter-cyan text-3xl">&times;</button>
            <img id="modalImage" src="" alt="Proof Image" class="w-full h-auto rounded-xl">
            <div class="mt-4 flex justify-center">
                <a id="downloadImageBtn" href="#" download class="px-6 py-3 bg-specter-cyan text-specter-darker font-semibold rounded-lg hover:bg-specter-cyanDark transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span data-i18n="downloadImage">Download Image</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-specter-border py-8 px-4 mt-12">
        <div class="max-w-7xl mx-auto text-center text-specter-textMuted text-sm">
            <p>&copy; 2024 ClavaStack. <span data-i18n="footerText">Powered by OpenTimestamps & Bitcoin Blockchain.</span></p>
        </div>
    </footer>

    <script>
        // ===========================================
        // Internationalization (i18n)
        // ===========================================
        const translations = {
            en: {
                addNew: "Add New",
                heroSubtitle: "packaged by ClavaStack",
                heroSlogan: "Trust the Source, Not the Route",
                heroDescription: "Every Specter Hardware Wallet packaged by ClavaStack is cryptographically timestamped on the Bitcoin blockchain. This provides immutable proof of packaging integrity that can be independently verified by anyone.",
                suppliersTitle: "Official Suppliers",
                proofTableTitle: "Verified Packaging Proofs",
                proofTableSubtitle: "All packages with Bitcoin blockchain timestamps",
                sortNewest: "Newest first",
                sortOldest: "Oldest first",
                sortBagIdAsc: "Bag ID (asc)",
                sortBagIdDesc: "Bag ID (desc)",
                colBagId: "Bag ID",
                colDate: "Date",
                colVersion: "Version",
                colPacker: "Packer",
                colProof: "Blockchain Proof",
                colImage: "Image",
                emptyTitle: "No proofs yet",
                emptyDescription: "Start by adding your first packaging proof.",
                addFirstProof: "Add First Proof",
                exportCSV: "Export as CSV",
                modalTitle: "Blockchain Timestamp Proof",
                verifiedTitle: "Verified on Bitcoin Blockchain",
                verifiedDescription: "This record was provably created before the stated time.",
                pendingTitle: "Awaiting Bitcoin Blockchain",
                pendingDescription: "Timestamp sent to calendar servers, waiting for Bitcoin block confirmation (few hours).",
                modalBagId: "Bag ID:",
                modalHash: "SHA-256 Hash:",
                modalBlock: "Bitcoin Block:",
                modalBlockTime: "Block Time:",
                modalCreated: "Created:",
                downloadOts: "Download .ots",
                verifyExternal: "Verify Externally",
                downloadImage: "Download Image",
                footerText: "Powered by OpenTimestamps & Bitcoin Blockchain.",
                timestamped: "Timestamped",
                pending: "Pending...",
                viewImage: "View"
            },
            de: {
                addNew: "Hinzufugen",
                heroSubtitle: "verpackt von ClavaStack",
                heroSlogan: "Vertraue der Quelle, nicht dem Weg",
                heroDescription: "Jede von ClavaStack verpackte Specter Hardware Wallet wird kryptografisch auf der Bitcoin-Blockchain mit einem Zeitstempel versehen. Dies bietet einen unveranderlichen Nachweis der Verpackungsintegritat, der von jedem unabhangig uberpruft werden kann.",
                suppliersTitle: "Offizielle Handler",
                proofTableTitle: "Verifizierte Verpackungsnachweise",
                proofTableSubtitle: "Alle Pakete mit Bitcoin-Blockchain-Zeitstempeln",
                sortNewest: "Neueste zuerst",
                sortOldest: "Alteste zuerst",
                sortBagIdAsc: "Bag ID (aufsteigend)",
                sortBagIdDesc: "Bag ID (absteigend)",
                colBagId: "Bag ID",
                colDate: "Datum",
                colVersion: "Version",
                colPacker: "Verpacker",
                colProof: "Blockchain Nachweis",
                colImage: "Bild",
                emptyTitle: "Noch keine Nachweise",
                emptyDescription: "Fugen Sie Ihren ersten Verpackungsnachweis hinzu.",
                addFirstProof: "Ersten Nachweis hinzufugen",
                exportCSV: "Als CSV exportieren",
                modalTitle: "Blockchain Zeitstempel-Nachweis",
                verifiedTitle: "Verifiziert auf der Bitcoin Blockchain",
                verifiedDescription: "Dieser Datensatz wurde nachweislich vor dem angegebenen Zeitpunkt erstellt.",
                pendingTitle: "Warte auf Bitcoin Blockchain",
                pendingDescription: "Zeitstempel an Calendar-Server gesendet, warte auf Bitcoin-Block-Bestatigung (einige Stunden).",
                modalBagId: "Bag ID:",
                modalHash: "SHA-256 Hash:",
                modalBlock: "Bitcoin Block:",
                modalBlockTime: "Block-Zeit:",
                modalCreated: "Erstellt am:",
                downloadOts: ".ots herunterladen",
                verifyExternal: "Extern verifizieren",
                downloadImage: "Bild herunterladen",
                footerText: "Powered by OpenTimestamps & Bitcoin Blockchain.",
                timestamped: "Zeitgestempelt",
                pending: "Ausstehend...",
                viewImage: "Ansehen"
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'en';

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            updateLanguage();
            toggleLanguageMenu();
        }

        function updateLanguage() {
            const t = translations[currentLanguage];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Update flag and language code
            document.getElementById('currentLang').textContent = currentLanguage.toUpperCase();
            document.getElementById('currentFlag').src = `assets/flags/${currentLanguage}.svg`;

            // Re-render proofs table with translated content
            renderProofs();
        }

        function toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            menu.classList.toggle('hidden');
        }

        // Close language menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('languageMenu');
            const btn = e.target.closest('button');
            if (!btn || !btn.onclick?.toString().includes('toggleLanguageMenu')) {
                if (!e.target.closest('#languageMenu')) {
                    menu.classList.add('hidden');
                }
            }
        });

        // ===========================================
        // Suppliers Data
        // ===========================================
        const suppliers = [
            { name: "ClavaStack", url: "https://clavastack.com/", logo: "assets/logos/ClavaStack.png", region: "Europe, Germany" },
            { name: "Pleb.Style", url: "https://pleb.style/", logo: "assets/logos/Plebstyle.jpg", region: "Europe, Germany" },
            { name: "Bayoto", url: "https://bayoto.me/", logo: "assets/logos/bayoto.svg", region: "Europe" },
            { name: "Cryptomaan", url: "https://cryptomaan.eu/collections/hardware-wallets", logo: "assets/logos/cryptomaan.svg", region: "Europe, Netherlands" },
            { name: "BTC Direct", url: "https://shop.btcdirect.eu/", logo: "assets/logos/btcdirect.svg", region: "Europe, Netherlands" },
            { name: "Dezentralshop", url: "https://dezentralshop.ch/", logo: "assets/logos/Dezentralshop.jpg", region: "Europe, Switzerland" },
            { name: "LWallet", url: "https://lwallet.com.ua/en/", logo: "assets/logos/lwallet.svg", region: "Europe, Ukraine" },
            { name: "Bitcoin Brabant", url: "https://bitcoinbrabant.com/", logo: "assets/logos/bitcoinbrabant.svg", region: "Europe, Netherlands" },
            { name: "Bitsaga", url: "https://bitsaga.be/", logo: "assets/logos/bitsaga.svg", region: "Europe, Belgium" }
        ];

        function renderSuppliers() {
            const grid = document.getElementById('suppliersGrid');
            grid.innerHTML = suppliers.map(s => `
                <a href="${s.url}" target="_blank" rel="noopener"
                   class="bg-specter-dark border border-specter-border rounded-xl p-4 hover:border-specter-cyan transition card-hover flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-specter-card rounded-lg flex items-center justify-center mb-3 overflow-hidden">
                        <img src="${s.logo}" alt="${s.name}" class="w-12 h-12 object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-2xl font-bold text-specter-cyan\\'>${s.name.charAt(0)}</span>'">
                    </div>
                    <h3 class="font-semibold text-white mb-1">${s.name}</h3>
                    <p class="text-xs text-specter-textMuted">${s.region}</p>
                </a>
            `).join('');
        }

        // ===========================================
        // Proofs Data & Rendering
        // ===========================================
        let allProofs = [];
        let currentTimestampData = null;

        function loadProofs() {
            const stored = localStorage.getItem('bag_timestamps');
            if (stored) {
                const timestamps = JSON.parse(stored);
                allProofs = Object.keys(timestamps).map(key => ({
                    bagId: key.replace('bag_', ''),
                    ...timestamps[key]
                }));
            }
            renderProofs();
        }

        function sortProofs(proofs) {
            const sortValue = document.getElementById('sortSelect').value;
            const sorted = [...proofs];

            switch (sortValue) {
                case 'date-desc':
                    sorted.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                    break;
                case 'date-asc':
                    sorted.sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
                    break;
                case 'bagId-asc':
                    sorted.sort((a, b) => (a.bagId || '').localeCompare(b.bagId || '', undefined, {numeric: true}));
                    break;
                case 'bagId-desc':
                    sorted.sort((a, b) => (b.bagId || '').localeCompare(a.bagId || '', undefined, {numeric: true}));
                    break;
            }
            return sorted;
        }

        function renderProofs() {
            const tbody = document.getElementById('proofsTableBody');
            const emptyState = document.getElementById('emptyState');
            const t = translations[currentLanguage];

            if (allProofs.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            const sorted = sortProofs(allProofs);

            tbody.innerHTML = sorted.map((proof, index) => {
                // Parse dataString to get version and packer
                let version = 'Unknown', packer = 'Unknown', date = '---';
                try {
                    const data = JSON.parse(proof.dataString);
                    version = data.version || 'Unknown';
                    packer = data.packer || 'Unknown';
                    date = data.date ? new Date(data.date).toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-US') : '---';
                } catch (e) {}

                // Proof badge
                let proofBadge;
                if (proof.status === 'verified') {
                    proofBadge = `
                        <button onclick="showTimestampModal(${index})"
                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-specter-success/20 text-specter-success rounded-full text-xs font-semibold hover:bg-specter-success/30 transition cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ${t.timestamped} @${proof.blockHeight}
                        </button>`;
                } else {
                    proofBadge = `
                        <button onclick="showTimestampModal(${index})"
                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-specter-warning/20 text-specter-warning rounded-full text-xs font-semibold hover:bg-specter-warning/30 transition cursor-pointer">
                            <svg class="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ${t.pending}
                        </button>`;
                }

                // Image button
                const imageBtn = proof.imageData ? `
                    <button onclick="showImageModal('${proof.imageData}')" class="text-specter-cyan hover:underline text-sm">
                        ${t.viewImage}
                    </button>
                ` : '<span class="text-specter-textMuted text-sm">-</span>';

                return `
                    <tr class="hover:bg-specter-dark/50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${proof.bagId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-specter-textMuted">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${version}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-specter-cyan">${packer}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${proofBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${imageBtn}</td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('sortSelect').addEventListener('change', renderProofs);

        // ===========================================
        // Modals
        // ===========================================
        function showTimestampModal(index) {
            const proof = sortProofs(allProofs)[index];
            if (!proof) return;

            currentTimestampData = proof;

            document.getElementById('tsModalBagId').textContent = proof.bagId;
            document.getElementById('tsModalHash').textContent = proof.hash;
            document.getElementById('tsModalCreated').textContent = new Date(proof.createdAt).toLocaleString(currentLanguage === 'de' ? 'de-DE' : 'en-US');

            const verifiedDiv = document.getElementById('timestampVerified');
            const pendingDiv = document.getElementById('timestampPending');
            const blockHeightRow = document.getElementById('tsBlockHeightRow');
            const blockTimeRow = document.getElementById('tsBlockTimeRow');

            if (proof.status === 'verified') {
                verifiedDiv.classList.remove('hidden');
                pendingDiv.classList.add('hidden');
                blockHeightRow.classList.remove('hidden');
                blockHeightRow.style.display = 'flex';
                blockTimeRow.classList.remove('hidden');
                blockTimeRow.style.display = 'flex';

                document.getElementById('tsModalBlockHeight').textContent = `#${proof.blockHeight}`;
                document.getElementById('tsModalBlockHeight').href = `https://mempool.space/block/${proof.blockHeight}`;
                document.getElementById('tsModalBlockTime').textContent = proof.blockTimeFormatted;
            } else {
                verifiedDiv.classList.add('hidden');
                pendingDiv.classList.remove('hidden');
                blockHeightRow.classList.add('hidden');
                blockHeightRow.style.display = 'none';
                blockTimeRow.classList.add('hidden');
                blockTimeRow.style.display = 'none';
            }

            document.getElementById('timestampModal').classList.remove('hidden');
            document.getElementById('timestampModal').style.display = 'flex';
        }

        function closeTimestampModal() {
            document.getElementById('timestampModal').classList.add('hidden');
            document.getElementById('timestampModal').style.display = 'none';
            currentTimestampData = null;
        }

        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        function downloadOtsFile() {
            if (!currentTimestampData) return;
            const otsBytes = hexToBytes(currentTimestampData.otsData);
            const blob = new Blob([otsBytes], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bag_${currentTimestampData.bagId}_timestamp.ots`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function verifyExternal() {
            window.open('https://opentimestamps.org/', '_blank');
        }

        function showImageModal(imageData) {
            document.getElementById('modalImage').src = imageData;
            document.getElementById('downloadImageBtn').href = imageData;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').style.display = 'flex';
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').style.display = 'none';
        }

        // Close modals on backdrop click
        document.getElementById('timestampModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('timestampModal')) closeTimestampModal();
        });
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('imageModal')) closeImageModal();
        });

        // ===========================================
        // CSV Export
        // ===========================================
        function exportCSV() {
            const t = translations[currentLanguage];
            let csv = `${t.colBagId},${t.colDate},${t.colVersion},${t.colPacker},${t.colProof},Hash\n`;

            allProofs.forEach(proof => {
                let version = '', packer = '', date = '';
                try {
                    const data = JSON.parse(proof.dataString);
                    version = data.version || '';
                    packer = data.packer || '';
                    date = data.date || '';
                } catch (e) {}

                const status = proof.status === 'verified' ? `Verified @${proof.blockHeight}` : 'Pending';
                csv += `"${proof.bagId}","${date}","${version}","${packer}","${status}","${proof.hash}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clavastack_proofs_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ===========================================
        // Initialize
        // ===========================================
        document.addEventListener('DOMContentLoaded', () => {
            updateLanguage();
            renderSuppliers();
            loadProofs();
        });
    </script>
</body>
</html>
