<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proof of Packaging - ClavaStack</title>
    <link rel="icon" type="image/png" href="assets/logos/proof_clavastack_removed.png">
    <link rel="stylesheet" href="dist/output.css">
    <script src="https://opentimestamps.org/assets/javascripts/vendor/opentimestamps.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Color Variables */
        :root {
            --primary: #1F99E5;
            --black: #04070B;
            --bg: #1E2734;
        }

        /* FIX: Supplier Logo Consistency */
        #suppliersGrid a > div:first-child {
            width: 90px !important;
            height: 90px !important;
            border-radius: 16px !important;
            background: linear-gradient(135deg, rgba(31,153,229,0.15), rgba(31,153,229,0.05)) !important;
            border: 2px solid rgba(31,153,229,0.25) !important;
        }

        #suppliersGrid a > div:first-child img {
            width: 70px !important;
            height: 70px !important;
            object-fit: contain !important;
            border-radius: 12px !important;
        }

        #suppliersGrid a {
            background: linear-gradient(135deg, #1E2734, #162032) !important;
            border: 2px solid rgba(31,153,229,0.2) !important;
            border-radius: 20px !important;
            padding: 32px 24px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #suppliersGrid a:hover {
            transform: translateY(-12px) scale(1.03) !important;
            border-color: #1F99E5 !important;
            background: linear-gradient(135deg, rgba(31,153,229,0.15), rgba(31,153,229,0.05)) !important;
            box-shadow: 0 30px 60px rgba(31,153,229,0.25) !important;
        }

        #suppliersGrid a h3 {
            font-size: 1.2rem;
            font-weight: 800;
            margin-top: 20px !important;
            margin-bottom: 10px !important;
            letter-spacing: -0.5px;
            color: white !important;
        }

        #suppliersGrid a p:first-of-type {
            color: #9CA3AF !important;
            font-size: 0.95rem;
            margin-bottom: 12px !important;
        }

        #suppliersGrid a p:last-child {
            display: inline-block;
            font-size: 0.85rem;
            padding: 8px 16px;
            background: rgba(31,153,229,0.15);
            border: 1.5px solid rgba(31,153,229,0.3);
            border-radius: 24px;
            color: #1F99E5;
            font-weight: 800;
            margin-top: 12px;
        }

        /* FIX: Search Icon Size - MUCH SMALLER */
        svg[viewBox="0 0 24 24"].absolute {
            width: 16px !important;
            height: 16px !important;
            left: 14px !important;
            color: #6B7280 !important;
        }

        /* Enhance search input */
        #searchInput {
            background: rgba(255, 255, 255, 0.06) !important;
            border: 2px solid rgba(31, 153, 229, 0.3) !important;
            padding: 10px 14px 10px 44px !important;
            font-size: 0.95rem !important;
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
            color: white !important;
        }

        #searchInput::placeholder {
            color: #6B7280 !important;
        }

        #searchInput:focus {
            border-color: #1F99E5 !important;
            box-shadow: 0 0 0 4px rgba(31, 153, 229, 0.15) !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Suppliers grid - make more spacious */
        #suppliersGrid {
            gap: 28px !important;
        }

        /* Override body background */
        body {
            background-color: #1E2734 !important;
        }

        @media (max-width: 768px) {
            #suppliersGrid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
                gap: 20px !important;
            }

            #suppliersGrid a > div:first-child {
                width: 75px !important;
                height: 75px !important;
            }

            #suppliersGrid a > div:first-child img {
                width: 55px !important;
                height: 55px !important;
                border-radius: 10px !important;
            }
        }

        /* Search Verification Styles */
        #bagIdSearchInput {
            letter-spacing: 0.5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #bagIdSearchInput:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(31, 153, 229, 0.2);
        }

        #verifyBagButton {
            position: relative;
            overflow: hidden;
        }

        #verifyBagButton::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        #verifyBagButton:hover::before {
            left: 100%;
        }

        /* Result Card Animation */
        #searchResultCard.show {
            display: block !important;
            animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Proof Details Grid Hover */
        .bg-specter-card\/50:hover {
            background-color: rgba(30, 39, 52, 0.7) !important;
            transform: translateY(-2px);
            transition: all 0.2s ease;
        }

        /* Mobile responsive search */
        @media (max-width: 640px) {
            #bagIdSearchInput {
                font-size: 1.125rem;
                padding: 1rem 1rem 1rem 3.5rem;
            }
        }
    </style>
</head>
<body class="text-specter-text">
    <!-- Header -->
    <header class="border-b border-specter-border bg-specter-darker/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="assets/logos/ClavaStack_3_4_1_removed.png" alt="ClavaStack" class="h-10 w-auto" onerror="this.style.display='none'">
                    <span class="text-xl font-bold">ClavaStack <span class="text-specter-cyan">Proof</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Language Switcher -->
                    <div class="relative">
                        <button onclick="toggleLanguageMenu()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-specter-card border border-specter-border hover:border-specter-cyan transition">
                            <img id="currentFlag" src="assets/flags/en.svg" alt="EN" class="w-5 h-4 rounded-sm object-cover">
                            <span id="currentLang" class="text-sm font-medium">EN</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="languageMenu" class="hidden absolute right-0 mt-2 w-40 bg-specter-card border border-specter-border rounded-lg shadow-xl overflow-hidden">
                            <button onclick="setLanguage('en')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-specter-border transition text-left">
                                <img src="assets/flags/en.svg" alt="EN" class="w-5 h-4 rounded-sm object-cover">
                                <span>English</span>
                            </button>
                            <button onclick="setLanguage('de')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-specter-border transition text-left">
                                <img src="assets/flags/de.svg" alt="DE" class="w-5 h-4 rounded-sm object-cover">
                                <span>Deutsch</span>
                            </button>
                        </div>
                    </div>
                    <!-- ClavaStack Link -->
                    <a href="https://clavastack.com/" target="_blank" rel="noopener" class="px-4 py-2 bg-specter-cyan text-specter-darker font-semibold rounded-lg hover:bg-specter-cyanDark transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        <span data-i18n="visitShop">Visit Shop</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="py-16 sm:py-24 px-4">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-6">
                <span class="text-white">Specter Hardware Wallets</span><br>
                <span class="gradient-text" data-i18n="heroSubtitle">packaged by ClavaStack</span>
            </h1>
            <p class="text-2xl sm:text-3xl font-semibold text-specter-cyan mb-8" data-i18n="heroSlogan">
                Trust the Source, Not the Route
            </p>
            <p class="text-lg text-specter-textMuted max-w-2xl mx-auto" data-i18n="heroDescription">
                Every Specter Hardware Wallet packaged by ClavaStack is cryptographically timestamped on the Bitcoin blockchain.
                This provides immutable proof of packaging integrity that can be independently verified by anyone.
            </p>
        </div>
    </section>

    <!-- Search Verification Section -->
    <section class="py-16 px-4">
        <div class="max-w-3xl mx-auto">
            <!-- Search Card -->
            <div class="bg-specter-card border-2 border-specter-border rounded-3xl p-8 sm:p-12 shadow-2xl">
                <div class="text-center mb-8">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-3" data-i18n="verifyTitle">Verify Your Bag</h2>
                    <p class="text-specter-textMuted text-lg" data-i18n="verifySubtitle">Enter your tamper-evident bag ID to verify blockchain proof</p>
                </div>

                <!-- Search Input Container -->
                <div class="relative mb-6">
                    <div class="relative">
                        <!-- Search Icon -->
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-specter-cyan pointer-events-none"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <!-- Search Input -->
                        <input type="text"
                               id="bagIdSearchInput"
                               class="w-full pl-16 pr-6 py-6 bg-specter-dark border-2 border-specter-border rounded-2xl text-xl sm:text-2xl font-semibold text-white placeholder-specter-textMuted focus:border-specter-cyan focus:outline-none focus:ring-4 focus:ring-specter-cyan/20 transition-all"
                               data-placeholder-i18n="searchPlaceholderBagId">
                    </div>
                </div>

                <!-- Verify Button -->
                <button id="verifyBagButton"
                        class="w-full py-5 bg-gradient-to-r from-specter-cyan to-specter-cyanDark text-white text-xl font-bold rounded-2xl hover:shadow-lg hover:shadow-specter-cyan/30 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-3"
                        data-i18n="verifyButton">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Verify Bag
                </button>

                <!-- OR divider -->
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-specter-border"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-3 bg-specter-card text-specter-textMuted" data-i18n="orDivider">or</span>
                    </div>
                </div>

                <!-- Camera Scan Button -->
                <button id="cameraScanButton"
                        class="w-full py-6 bg-gradient-to-r from-green-500 to-green-600 text-white text-xl font-bold rounded-2xl hover:shadow-lg hover:shadow-green-500/30 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-3">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                              d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span data-i18n="scanYourBag">Scan Your Bag</span>
                </button>
            </div>

            <!-- Result Card (Hidden by default, shown with animation) -->
            <div id="searchResultCard" class="hidden mt-8 opacity-0 transform translate-y-4 transition-all duration-500">
                <!-- Success State -->
                <div id="resultSuccess" class="hidden bg-gradient-to-br from-green-500/10 to-green-500/5 border-2 border-green-500 rounded-3xl p-8 shadow-xl">
                    <!-- Success Header -->
                    <div class="flex items-center gap-4 mb-6 pb-6 border-b border-green-500/30">
                        <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-green-500" data-i18n="verifiedBagTitle">Verified Bag Found</h3>
                            <p class="text-specter-textMuted" data-i18n="verifiedBagSubtitle">This bag is authentically timestamped</p>
                        </div>
                    </div>

                    <!-- Proof Details Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <!-- Bag ID -->
                        <div class="bg-specter-card/50 rounded-xl p-4 border border-green-500/20">
                            <p class="text-xs text-specter-textMuted uppercase tracking-wider mb-1" data-i18n="colBagId">Bag ID</p>
                            <p id="resultBagId" class="text-lg font-mono font-bold text-white"></p>
                        </div>
                        <!-- Date -->
                        <div class="bg-specter-card/50 rounded-xl p-4 border border-green-500/20">
                            <p class="text-xs text-specter-textMuted uppercase tracking-wider mb-1" data-i18n="colDate">Date</p>
                            <p id="resultDate" class="text-lg font-semibold text-white"></p>
                        </div>
                        <!-- Version -->
                        <div class="bg-specter-card/50 rounded-xl p-4 border border-green-500/20">
                            <p class="text-xs text-specter-textMuted uppercase tracking-wider mb-1" data-i18n="colVersion">Version</p>
                            <div id="resultVersion" class="text-lg font-semibold"></div>
                        </div>
                        <!-- Packer -->
                        <div class="bg-specter-card/50 rounded-xl p-4 border border-green-500/20">
                            <p class="text-xs text-specter-textMuted uppercase tracking-wider mb-1" data-i18n="colPacker">Packer</p>
                            <div id="resultPacker" class="text-lg font-semibold"></div>
                        </div>
                    </div>

                    <!-- Blockchain Proof Badge -->
                    <div id="resultProofBadge" class="mb-6"></div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="resultViewImage"
                                class="flex-1 px-6 py-4 bg-specter-cyan text-white font-semibold rounded-xl hover:bg-specter-cyanDark transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span data-i18n="viewImage">View Image</span>
                        </button>
                        <button id="resultViewProof"
                                class="flex-1 px-6 py-4 bg-specter-dark border-2 border-specter-border text-white font-semibold rounded-xl hover:border-specter-cyan transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span data-i18n="viewBlockchainProof">View Blockchain Proof</span>
                        </button>
                    </div>
                </div>

                <!-- Error State -->
                <div id="resultError" class="hidden bg-gradient-to-br from-red-500/10 to-red-500/5 border-2 border-red-500 rounded-3xl p-8 shadow-xl">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-red-500" data-i18n="notFoundTitle">Bag Not Found</h3>
                            <p class="text-specter-textMuted mt-1" data-i18n="notFoundMessage">No verification found for this bag ID. Please check the ID and try again.</p>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-specter-card/50 rounded-xl border border-red-500/20">
                        <p class="text-sm text-specter-textMuted" data-i18n="notFoundHint">Tip: Bag IDs are case-sensitive. Make sure to enter the exact ID from your tamper-evident bag.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Official Suppliers Section -->
    <section class="py-16 px-4 border-t border-specter-border mt-12">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-8" data-i18n="suppliersTitle">Official Suppliers</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" id="suppliersGrid">
                <!-- Suppliers will be rendered here -->
            </div>
        </div>
    </section>

    <!-- Timestamp Proof Modal -->
    <div id="timestampModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-specter-card border border-specter-border rounded-2xl shadow-2xl max-w-lg mx-4 p-6 w-full">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-xl font-bold" data-i18n="modalTitle">Blockchain Timestamp Proof</h3>
                <button onclick="closeTimestampModal()" class="text-specter-textMuted hover:text-white text-2xl">&times;</button>
            </div>

            <div id="timestampVerified" class="hidden mb-6 p-4 bg-specter-success/10 border border-specter-success/30 rounded-xl">
                <div class="flex items-center gap-2 text-specter-success font-semibold mb-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span data-i18n="verifiedTitle">Verified on Bitcoin Blockchain</span>
                </div>
                <p class="text-sm text-specter-success/80" data-i18n="verifiedDescription">This record was provably created before the stated time.</p>
            </div>

            <div id="timestampPending" class="hidden mb-6 p-4 bg-specter-warning/10 border border-specter-warning/30 rounded-xl">
                <div class="flex items-center gap-2 text-specter-warning font-semibold mb-2">
                    <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span data-i18n="pendingTitle">Awaiting Bitcoin Blockchain</span>
                </div>
                <p class="text-sm text-specter-warning/80" data-i18n="pendingDescription">Timestamp sent to calendar servers, waiting for Bitcoin block confirmation (few hours).</p>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalBagId">Bag ID:</span>
                    <span id="tsModalBagId" class="font-mono text-white"></span>
                </div>
                <div class="flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalHash">SHA-256 Hash:</span>
                    <span id="tsModalHash" class="font-mono text-xs text-white break-all max-w-[200px]"></span>
                </div>
                <div id="tsBlockHeightRow" class="hidden flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalBlock">Bitcoin Block:</span>
                    <a id="tsModalBlockHeight" href="#" target="_blank" class="font-mono text-specter-cyan hover:underline"></a>
                </div>
                <div id="tsBlockTimeRow" class="hidden flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalBlockTime">Block Time:</span>
                    <span id="tsModalBlockTime" class="text-white"></span>
                </div>
                <div class="flex justify-between items-center py-3 border-b border-specter-border">
                    <span class="text-specter-textMuted text-sm" data-i18n="modalCreated">Created:</span>
                    <span id="tsModalCreated" class="text-white"></span>
                </div>
            </div>

            <div class="mt-6 flex flex-col gap-3">
                <div class="flex gap-3">
                    <button id="downloadOtsButton" onclick="downloadOtsFile()" class="flex-1 px-4 py-3 bg-specter-cyan text-specter-darker font-semibold rounded-lg hover:bg-specter-cyanDark transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span data-i18n="downloadOts">Download .ots</span>
                    </button>
                    <button onclick="verifyExternal()" class="flex-1 px-4 py-3 bg-specter-dark border border-specter-border text-white font-semibold rounded-lg hover:border-specter-cyan transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        <span data-i18n="verifyExternal">Verify Externally</span>
                    </button>
                </div>
                <button id="downloadTimestampImage" onclick="downloadTimestampImage()" class="hidden w-full px-4 py-3 bg-specter-dark border border-specter-border text-white font-semibold rounded-lg hover:border-specter-cyan transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span data-i18n="downloadTimestampedImage">Download Timestamped Image</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="relative max-w-4xl w-full">
            <button onclick="closeImageModal()" class="absolute -top-12 right-0 text-white hover:text-specter-cyan text-3xl">&times;</button>
            <img id="modalImage" src="" alt="Proof Image" class="w-full h-auto rounded-xl">
            <div class="mt-4 flex justify-center">
                <a id="downloadImageBtn" href="#" download class="px-6 py-3 bg-specter-cyan text-specter-darker font-semibold rounded-lg hover:bg-specter-cyanDark transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span data-i18n="downloadImage">Download Image</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Camera Scan Modal -->
    <div id="cameraScanModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="relative max-w-2xl w-full">
            <!-- Close Button -->
            <button onclick="closeCameraScan()" class="absolute -top-12 right-0 text-white hover:text-specter-cyan text-3xl z-10">&times;</button>

            <div class="bg-specter-card border border-specter-border rounded-2xl overflow-hidden shadow-2xl">
                <!-- Header -->
                <div class="bg-gradient-to-r from-green-500/20 to-green-600/20 border-b border-specter-border px-6 py-4">
                    <h2 class="text-2xl font-bold text-white" data-i18n="scanTitle">Scan Tamper-Evident Bag</h2>
                    <p class="text-specter-textMuted text-sm mt-1" data-i18n="scanInstructions">Position your bag in the camera frame and capture</p>
                </div>

                <!-- Camera Container -->
                <div class="relative bg-black">
                    <!-- Video Preview -->
                    <video id="cameraScanPreview" class="w-full h-auto bg-black" style="max-height: 500px;"></video>

                    <!-- Loading Spinner -->
                    <div id="cameraScanLoading" class="absolute inset-0 hidden flex items-center justify-center bg-black/50">
                        <div class="text-center">
                            <div class="w-12 h-12 border-4 border-green-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                            <p class="text-white font-semibold" data-i18n="cameraInitializing">Initializing camera...</p>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="cameraScanError" class="absolute inset-0 hidden flex items-center justify-center bg-red-500/20">
                        <div class="text-center">
                            <svg class="w-12 h-12 text-red-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p id="cameraScanErrorMsg" class="text-red-500 font-semibold" data-i18n="cameraError">Unable to access camera</p>
                        </div>
                    </div>

                    <!-- Hidden Canvas for Photo Capture -->
                    <canvas id="cameraScanCanvas" class="hidden"></canvas>
                </div>

                <!-- Controls -->
                <div class="bg-specter-darker border-t border-specter-border p-4 flex gap-3 justify-center flex-wrap">
                    <button id="cameraSwitchButton" onclick="switchCameraScan()" class="px-4 py-3 bg-specter-dark border border-specter-border text-white font-semibold rounded-lg hover:border-specter-cyan transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m0 0l4 4m10-4v12m0 0l4-4m0 0l-4-4"></path>
                        </svg>
                        <span data-i18n="cameraSwitchCamera">Switch Camera</span>
                    </button>
                    <button onclick="captureScanPhoto()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-lg hover:shadow-lg hover:shadow-green-500/30 transition flex items-center gap-2 flex-1 sm:flex-none justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0118.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span data-i18n="cameraCapture">Capture</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Packer Modal -->
    <div id="packerModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-specter-card border border-specter-border rounded-2xl shadow-2xl max-w-md mx-4 p-6">
            <div class="flex justify-between items-start mb-4">
                <h3 id="packerName" class="text-2xl font-bold text-white"></h3>
                <button onclick="closePackerModal()" class="text-specter-textMuted hover:text-white text-2xl">&times;</button>
            </div>
            <p id="packerDescription" class="text-specter-textMuted mb-4"></p>
            <a id="packerTwitter" href="#" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-white text-black rounded-lg hover:bg-specter-text transition">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                X/Twitter
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-specter-border py-8 px-4 mt-12">
        <div class="max-w-7xl mx-auto text-center text-specter-textMuted text-sm">
            <p>&copy; 2024 ClavaStack. <span data-i18n="footerText">Powered by OpenTimestamps & Bitcoin Blockchain.</span></p>
        </div>
    </footer>

    <script>
        // ===========================================
        // Internationalization (i18n)
        // ===========================================
        const translations = {
            en: {
                visitShop: "Visit Shop",
                heroSubtitle: "packaged by ClavaStack",
                heroSlogan: "Trust the Source, Not the Route",
                heroDescription: "Every Specter Hardware Wallet packaged by ClavaStack is cryptographically timestamped on the Bitcoin blockchain. This provides immutable proof of packaging integrity that can be independently verified by anyone.",
                suppliersTitle: "Official Suppliers",
                shipsFromClavaStack: "Ships directly from ClavaStack",
                shipsOwnWarehouse: "Ships from own warehouse",
                proofTableTitle: "Verified Packaging Proofs",
                proofTableSubtitle: "All packages with Bitcoin blockchain timestamps",
                sortNewest: "Newest first",
                sortOldest: "Oldest first",
                sortBagIdAsc: "Bag ID (asc)",
                sortBagIdDesc: "Bag ID (desc)",
                colBagId: "Bag ID",
                colDate: "Date",
                colVersion: "Version",
                colPacker: "Packer",
                colProof: "Blockchain Proof",
                colImage: "Image",
                emptyTitle: "No proofs yet",
                emptyDescription2: "Proofs will appear here once packages are verified.",
                exportCSV: "Export as CSV",
                modalTitle: "Blockchain Timestamp Proof",
                verifiedTitle: "Verified on Bitcoin Blockchain",
                verifiedDescription: "This record was provably created before the stated time.",
                pendingTitle: "Awaiting Bitcoin Blockchain",
                pendingDescription: "Timestamp sent to calendar servers, waiting for Bitcoin block confirmation (few hours).",
                modalBagId: "Bag ID:",
                modalHash: "SHA-256 Hash:",
                modalBlock: "Bitcoin Block:",
                modalBlockTime: "Block Time:",
                modalCreated: "Created:",
                downloadOts: "Download .ots",
                verifyExternal: "Verify Externally",
                downloadImage: "Download Image",
                downloadTimestampedImage: "Download Timestamped Image",
                footerText: "Powered by OpenTimestamps & Bitcoin Blockchain.",
                timestamped: "Timestamped",
                pending: "Pending...",
                viewImage: "View",
                searchPlaceholder: "Search by Bag ID, Date, Version, Packer, Block...",
                verifyTitle: "Verify Your Bag",
                verifySubtitle: "Enter your tamper-evident bag ID to verify blockchain proof",
                searchPlaceholderBagId: "Enter Bag ID (e.g., SN001234)",
                verifyButton: "Verify Bag",
                verifiedBagTitle: "Verified Bag Found",
                verifiedBagSubtitle: "This bag is authentically timestamped",
                viewBlockchainProof: "View Blockchain Proof",
                notFoundTitle: "Bag Not Found",
                notFoundMessage: "No verification found for this bag ID. Please check the ID and try again.",
                notFoundHint: "Tip: Bag IDs are case-sensitive. Make sure to enter the exact ID from your tamper-evident bag.",
                orDivider: "or",
                scanYourBag: "Scan Your Bag",
                analyzing: "Analyzing...",
                cameraCapture: "Capture",
                cameraSwitchCamera: "Switch Camera",
                cameraClose: "Close",
                scanTitle: "Scan Tamper-Evident Bag",
                scanInstructions: "Position your bag in the camera frame and capture",
                cameraInitializing: "Initializing camera...",
                cameraError: "Unable to access camera"
            },
            de: {
                visitShop: "Zum Shop",
                heroSubtitle: "verpackt von ClavaStack",
                heroSlogan: "Vertraue der Quelle, nicht dem Weg",
                heroDescription: "Jede von ClavaStack verpackte Specter Hardware Wallet wird kryptografisch auf der Bitcoin-Blockchain mit einem Zeitstempel versehen. Dies bietet einen unveranderlichen Nachweis der Verpackungsintegritat, der von jedem unabhangig uberpruft werden kann.",
                suppliersTitle: "Offizielle Händler",
                shipsFromClavaStack: "Versand direkt von ClavaStack",
                shipsOwnWarehouse: "Versand aus eigenem Lager",
                proofTableTitle: "Verifizierte Verpackungsnachweise",
                proofTableSubtitle: "Alle Pakete mit Bitcoin-Blockchain-Zeitstempeln",
                sortNewest: "Neueste zuerst",
                sortOldest: "Alteste zuerst",
                sortBagIdAsc: "Bag ID (aufsteigend)",
                sortBagIdDesc: "Bag ID (absteigend)",
                colBagId: "Bag ID",
                colDate: "Datum",
                colVersion: "Version",
                colPacker: "Verpacker",
                colProof: "Blockchain Nachweis",
                colImage: "Bild",
                emptyTitle: "Noch keine Nachweise",
                emptyDescription2: "Nachweise erscheinen hier, sobald Pakete verifiziert sind.",
                exportCSV: "Als CSV exportieren",
                modalTitle: "Blockchain Zeitstempel-Nachweis",
                verifiedTitle: "Verifiziert auf der Bitcoin Blockchain",
                verifiedDescription: "Dieser Datensatz wurde nachweislich vor dem angegebenen Zeitpunkt erstellt.",
                pendingTitle: "Warte auf Bitcoin Blockchain",
                pendingDescription: "Zeitstempel an Calendar-Server gesendet, warte auf Bitcoin-Block-Bestatigung (einige Stunden).",
                modalBagId: "Bag ID:",
                modalHash: "SHA-256 Hash:",
                modalBlock: "Bitcoin Block:",
                modalBlockTime: "Block-Zeit:",
                modalCreated: "Erstellt am:",
                downloadOts: ".ots herunterladen",
                verifyExternal: "Extern verifizieren",
                downloadImage: "Bild herunterladen",
                downloadTimestampedImage: "Zeitgestempeltes Bild herunterladen",
                footerText: "Powered by OpenTimestamps & Bitcoin Blockchain.",
                timestamped: "Zeitgestempelt",
                pending: "Ausstehend...",
                viewImage: "Ansehen",
                searchPlaceholder: "Suche nach Bag ID, Datum, Version, Verpacker, Block...",
                verifyTitle: "Beutel Verifizieren",
                verifySubtitle: "Geben Sie Ihre Manipulationsschutz-Beutel-ID ein, um den Blockchain-Nachweis zu verifizieren",
                searchPlaceholderBagId: "Beutel-ID eingeben (z.B. SN001234)",
                verifyButton: "Beutel Verifizieren",
                verifiedBagTitle: "Verifizierter Beutel Gefunden",
                verifiedBagSubtitle: "Dieser Beutel ist authentisch zeitgestempelt",
                viewBlockchainProof: "Blockchain-Nachweis Anzeigen",
                notFoundTitle: "Beutel Nicht Gefunden",
                notFoundMessage: "Keine Verifizierung für diese Beutel-ID gefunden. Bitte überprüfen Sie die ID und versuchen Sie es erneut.",
                notFoundHint: "Tipp: Beutel-IDs sind groß-/kleinschreibungsabhängig. Stellen Sie sicher, dass Sie die genaue ID von Ihrem Manipulationsschutz-Beutel eingeben.",
                orDivider: "oder",
                scanYourBag: "Beutel Scannen",
                analyzing: "Analysiere...",
                cameraCapture: "Aufnehmen",
                cameraSwitchCamera: "Kamera Wechseln",
                cameraClose: "Schließen",
                scanTitle: "Manipulationsschutz-Beutel Scannen",
                scanInstructions: "Platzieren Sie Ihren Beutel im Kamerarahmen und machen Sie ein Foto",
                cameraInitializing: "Initialisiere Kamera...",
                cameraError: "Auf Kamera kann nicht zugegriffen werden"
            }
        };

        // Packer profiles (shared with add page)
        const PACKERS = {
            "Schnuartz": {
                name: "Schnuartz",
                description: {
                    en: "Schnuartz founded ClavaStack, a retailer for Specter wallets, and produced over 90 german tutorials for the EINUNDZWANZIG channel. He is the first president of the Specter Association.",
                    de: "Schnuartz hat ClavaStack gegründet, einen Händler für Specter Wallets, und über 90 deutsche Tutorials für den EINUNDZWANZIG Kanal produziert. Er ist der erste Präsident des Specter Vereins."
                },
                twitter: "https://x.com/schnuartz"
            }
        };

        // Firmware version links
        const FIRMWARE_LINKS = {
            "v1.5.7": "https://github.com/cryptoadvance/specter-diy/releases/tag/v1.5.7",
            "v1.5.6": "https://github.com/cryptoadvance/specter-diy/releases/tag/v1.5.6",
            "v1.5.5": "https://github.com/cryptoadvance/specter-diy/releases/tag/v1.5.5",
            "v1.6.0": "https://github.com/cryptoadvance/specter-diy/releases/tag/v1.6.0",
            "v1.7.0": "https://github.com/cryptoadvance/specter-diy/releases/tag/v1.7.0",
            "v1.8.0": "https://github.com/cryptoadvance/specter-diy/releases/tag/v1.8.0",
            "v1.9.0": "https://github.com/cryptoadvance/specter-diy/releases/tag/v1.9.0",
            "v2.0.0": "https://github.com/cryptoadvance/specter-diy/releases/tag/v2.0.0"
        };

        // Get firmware link for a version (supports partial matches)
        function getFirmwareLink(version) {
            if (!version || version === 'Unknown') return null;
            // Direct match
            if (FIRMWARE_LINKS[version]) return FIRMWARE_LINKS[version];
            // Try with 'v' prefix
            if (FIRMWARE_LINKS['v' + version]) return FIRMWARE_LINKS['v' + version];
            // Fallback to releases page
            return 'https://github.com/cryptoadvance/specter-diy/releases';
        }

        let currentLanguage = localStorage.getItem('language') || 'en';
        let searchQuery = '';

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            updateLanguage();
            toggleLanguageMenu();
        }

        function updateLanguage() {
            const t = translations[currentLanguage];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-placeholder-i18n]').forEach(el => {
                const key = el.getAttribute('data-placeholder-i18n');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });

            // Update flag and language code
            document.getElementById('currentLang').textContent = currentLanguage.toUpperCase();
            document.getElementById('currentFlag').src = `assets/flags/${currentLanguage}.svg`;

            // Re-render suppliers with translated content
            renderSuppliers();
        }

        function toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            menu.classList.toggle('hidden');
        }

        // Close language menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('languageMenu');
            const btn = e.target.closest('button');
            if (!btn || !btn.onclick?.toString().includes('toggleLanguageMenu')) {
                if (!e.target.closest('#languageMenu')) {
                    menu.classList.add('hidden');
                }
            }
        });

        // ===========================================
        // Suppliers Data
        // ===========================================
        const suppliers = [
            { name: "ClavaStack", url: "https://clavastack.com/", logo: "assets/logos/ClavaStack.png", region: { en: "Europe, Germany", de: "Europa, Deutschland" }, ownWarehouse: true },
            { name: "Pleb.Style", url: "https://pleb.style/", logo: "assets/logos/Plebstyle.jpg", region: { en: "Europe, Germany", de: "Europa, Deutschland" }, ownWarehouse: false },
            { name: "Bayoto", url: "https://bayoto.me/", logo: "assets/logos/Bayoto.jpg", region: { en: "Europe, Denmark", de: "Europa, Dänemark" }, ownWarehouse: true },
            { name: "Cryptomaan", url: "https://cryptomaan.eu/collections/hardware-wallets", logo: "assets/logos/Cryptomaan.jpg", region: { en: "Europe, Netherlands", de: "Europa, Niederlande" }, ownWarehouse: false },
            { name: "BTC Direct", url: "https://shop.btcdirect.eu/", logo: "assets/logos/btcdirect.jpg", region: { en: "Europe, Netherlands", de: "Europa, Niederlande" }, ownWarehouse: false },
            { name: "Dezentralshop", url: "https://dezentralshop.ch/", logo: "assets/logos/Dezentralshop.jpg", region: { en: "Europe, Switzerland", de: "Europa, Schweiz" }, ownWarehouse: true },
            { name: "LWallet", url: "https://lwallet.com.ua/en/", logo: "assets/logos/Lwallet.jpg", region: { en: "Europe, Ukraine", de: "Europa, Ukraine" }, ownWarehouse: false },
            { name: "Bitcoin Brabant", url: "https://bitcoinbrabant.com/", logo: "assets/logos/BitcoinBrabant.jpg", region: { en: "Europe, Netherlands", de: "Europa, Niederlande" }, ownWarehouse: false },
            { name: "Bitsaga", url: "https://bitsaga.be/", logo: "assets/logos/BitSaga.jpg", region: { en: "Europe, Belgium", de: "Europa, Belgien" }, ownWarehouse: false },
            { name: "Bitcoin Bazis", url: "https://bitcoinbazis.hu/", logo: "assets/logos/BitcoinBazis.jpg", region: { en: "Europe, Hungary", de: "Europa, Ungarn" }, ownWarehouse: true }
        ];

        function renderSuppliers() {
            const grid = document.getElementById('suppliersGrid');
            const t = translations[currentLanguage];
            grid.innerHTML = suppliers.map(s => {
                const region = typeof s.region === 'object' ? (s.region[currentLanguage] || s.region.en) : s.region;
                const shipsFrom = s.ownWarehouse ? t.shipsOwnWarehouse : t.shipsFromClavaStack;
                return `
                <a href="${s.url}" target="_blank" rel="noopener"
                   class="bg-specter-dark border border-specter-border rounded-xl p-4 hover:border-specter-cyan transition card-hover flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-specter-card rounded-lg flex items-center justify-center mb-3 overflow-hidden">
                        <img src="${s.logo}" alt="${s.name}" class="w-12 h-12 object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-2xl font-bold text-specter-cyan\\'>${s.name.charAt(0)}</span>'">
                    </div>
                    <h3 class="font-semibold text-white mb-1">${s.name}</h3>
                    <p class="text-xs text-specter-textMuted">${region}</p>
                    <p class="text-xs text-specter-cyan mt-1">${shipsFrom}</p>
                </a>
            `}).join('');
        }

        // ===========================================
        // API Configuration
        // ===========================================
        const API_BASE_URL = "https://secure-ai-proxy-server-187831042201.europe-west1.run.app";

        // ===========================================
        // Proofs Data & Rendering
        // ===========================================
        let allProofs = [];
        let currentTimestampData = null;

        async function loadProofs() {
            try {
                console.log("Loading proofs from API...");
                const response = await fetch(`${API_BASE_URL}/api/proofs`);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                const data = await response.json();
                allProofs = data.proofs || [];
                console.log(`Loaded ${allProofs.length} proofs from API`);
            } catch (error) {
                console.error("Error loading proofs from API:", error);
                allProofs = [];
            }
        }


        // ===========================================
        // Modals
        // ===========================================
        function showTimestampModal(index) {
            // Direct access - no filtering/sorting needed in search-only UI
            const proof = allProofs[index];
            if (!proof) return;

            currentTimestampData = proof;

            document.getElementById('tsModalBagId').textContent = proof.bagId;
            document.getElementById('tsModalHash').textContent = proof.hash;
            document.getElementById('tsModalCreated').textContent = new Date(proof.createdAt).toLocaleString(currentLanguage === 'de' ? 'de-DE' : 'en-US');

            const verifiedDiv = document.getElementById('timestampVerified');
            const pendingDiv = document.getElementById('timestampPending');
            const blockHeightRow = document.getElementById('tsBlockHeightRow');
            const blockTimeRow = document.getElementById('tsBlockTimeRow');

            if (proof.status === 'verified') {
                verifiedDiv.classList.remove('hidden');
                pendingDiv.classList.add('hidden');
                blockHeightRow.classList.remove('hidden');
                blockHeightRow.style.display = 'flex';
                blockTimeRow.classList.remove('hidden');
                blockTimeRow.style.display = 'flex';

                document.getElementById('tsModalBlockHeight').textContent = `#${proof.blockHeight}`;
                document.getElementById('tsModalBlockHeight').href = `https://mempool.space/block/${proof.blockHeight}`;
                document.getElementById('tsModalBlockTime').textContent = proof.blockTimeFormatted;
            } else {
                verifiedDiv.classList.add('hidden');
                pendingDiv.classList.remove('hidden');
                blockHeightRow.classList.add('hidden');
                blockHeightRow.style.display = 'none';
                blockTimeRow.classList.add('hidden');
                blockTimeRow.style.display = 'none';
            }

            // Show/hide image download button
            const downloadImageBtn = document.getElementById('downloadTimestampImage');
            if (proof.imageUrl) {
                downloadImageBtn.classList.remove('hidden');
                downloadImageBtn.style.display = 'flex';
            } else {
                downloadImageBtn.classList.add('hidden');
                downloadImageBtn.style.display = 'none';
            }

            document.getElementById('timestampModal').classList.remove('hidden');
            document.getElementById('timestampModal').style.display = 'flex';
        }

        function closeTimestampModal() {
            document.getElementById('timestampModal').classList.add('hidden');
            document.getElementById('timestampModal').style.display = 'none';
            currentTimestampData = null;
        }

        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        function downloadOtsFile() {
            if (!currentTimestampData) return;
            const otsBytes = hexToBytes(currentTimestampData.otsData);
            const blob = new Blob([otsBytes], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bag_${currentTimestampData.bagId}_timestamp.ots`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadTimestampImage() {
            if (!currentTimestampData || !currentTimestampData.imageUrl) return;
            // Open image URL in new tab for download (CORS prevents direct download)
            window.open(currentTimestampData.imageUrl, '_blank');
        }

        function verifyExternal() {
            window.open('https://opentimestamps.org/', '_blank');
        }

        function showImageModal(imageData) {
            document.getElementById('modalImage').src = imageData;
            document.getElementById('downloadImageBtn').href = imageData;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').style.display = 'flex';
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').style.display = 'none';
        }

        // Packer Modal
        function showPackerModal(packerName) {
            const packer = PACKERS[packerName];
            if (!packer) return;
            document.getElementById('packerName').textContent = packer.name;
            // Use description based on current language
            const description = typeof packer.description === 'object'
                ? (packer.description[currentLanguage] || packer.description.en)
                : packer.description;
            document.getElementById('packerDescription').textContent = description;
            document.getElementById('packerTwitter').href = packer.twitter;
            document.getElementById('packerModal').classList.remove('hidden');
            document.getElementById('packerModal').style.display = 'flex';
        }

        function closePackerModal() {
            document.getElementById('packerModal').classList.add('hidden');
            document.getElementById('packerModal').style.display = 'none';
        }

        // Close modals on backdrop click
        document.getElementById('timestampModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('timestampModal')) closeTimestampModal();
        });
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('imageModal')) closeImageModal();
        });
        document.getElementById('packerModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('packerModal')) closePackerModal();
        });

        // ===========================================
        // Camera Scan Functions
        // ===========================================
        let cameraScanStream = null;
        let currentScanFacingMode = 'environment';

        async function openCameraScan() {
            const modal = document.getElementById('cameraScanModal');
            const video = document.getElementById('cameraScanPreview');
            const loading = document.getElementById('cameraScanLoading');
            const errorDiv = document.getElementById('cameraScanError');

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            try {
                const constraints = {
                    video: {
                        facingMode: currentScanFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                cameraScanStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraScanStream;
                await video.play();
                loading.classList.add('hidden');
            } catch (error) {
                console.error('Camera error:', error);
                loading.classList.add('hidden');
                errorDiv.classList.remove('hidden');
            }
        }

        function closeCameraScan() {
            const modal = document.getElementById('cameraScanModal');
            const video = document.getElementById('cameraScanPreview');

            if (cameraScanStream) {
                cameraScanStream.getTracks().forEach(track => track.stop());
                cameraScanStream = null;
            }
            video.srcObject = null;
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        async function switchCameraScan() {
            currentScanFacingMode = currentScanFacingMode === 'environment' ? 'user' : 'environment';

            if (cameraScanStream) {
                cameraScanStream.getTracks().forEach(track => track.stop());
            }

            const video = document.getElementById('cameraScanPreview');
            const loading = document.getElementById('cameraScanLoading');

            loading.classList.remove('hidden');

            try {
                const constraints = {
                    video: {
                        facingMode: currentScanFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                cameraScanStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraScanStream;
                await video.play();
                loading.classList.add('hidden');
            } catch (error) {
                console.error('Camera switch error:', error);
                loading.classList.add('hidden');
            }
        }

        async function captureScanPhoto() {
            const video = document.getElementById('cameraScanPreview');
            const canvas = document.getElementById('cameraScanCanvas');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                const file = new File([blob], `scan_${Date.now()}.jpg`, { type: 'image/jpeg' });

                closeCameraScan();

                const scanButton = document.getElementById('cameraScanButton');
                scanButton.disabled = true;
                scanButton.innerHTML = `
                    <svg class="w-6 h-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span data-i18n="analyzing">Analyzing...</span>
                `;

                try {
                    const base64Data = await base64EncodeFile(file);

                    const response = await fetch(`${API_BASE_URL}/api/verify-serial-number`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mimeType: file.type,
                            data: base64Data
                        })
                    });

                    if (!response.ok) {
                        throw new Error('AI analysis failed');
                    }

                    const result = await response.json();

                    if (result && result.length > 0 && result[0].bagId) {
                        const bagId = result[0].bagId;

                        const searchInput = document.getElementById('bagIdSearchInput');
                        searchInput.value = bagId;

                        setTimeout(() => {
                            verifyBag();
                        }, 300);
                    } else {
                        alert('No Bag ID found in image. Please try again.');
                    }

                } catch (error) {
                    console.error('Scan error:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        type: error.type,
                        status: error.status
                    });

                    // Show more detailed error message
                    let errorMsg = 'Failed to scan bag. ';
                    if (error.message.includes('CORS') || error.message.includes('cors')) {
                        errorMsg += 'CORS error - check browser console for details.';
                    } else if (error.message.includes('AI analysis failed')) {
                        errorMsg += 'AI service returned an error. Please try again.';
                    } else {
                        errorMsg += error.message || 'Please try again or enter manually.';
                    }
                    alert(errorMsg);
                } finally {
                    scanButton.disabled = false;
                    scanButton.innerHTML = `
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0118.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span data-i18n="scanYourBag">Scan Your Bag</span>
                    `;
                }
            }, 'image/jpeg', 0.9);
        }

        function base64EncodeFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // ===========================================
        // Search Verification
        // ===========================================
        let currentResultProof = null;

        function verifyBag() {
            const input = document.getElementById('bagIdSearchInput');
            const bagId = input.value.trim();

            if (!bagId) {
                return; // Empty input
            }

            // Exact match (case-sensitive)
            const proof = allProofs.find(p => p.bagId === bagId);
            showSearchResult(proof);
        }

        function showSearchResult(proof) {
            const resultCard = document.getElementById('searchResultCard');
            const successDiv = document.getElementById('resultSuccess');
            const errorDiv = document.getElementById('resultError');

            // Reset states
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            resultCard.classList.remove('show');

            if (proof) {
                // Found - show green success
                currentResultProof = proof;
                populateSuccessCard(proof);
                successDiv.classList.remove('hidden');
            } else {
                // Not found - show red error
                currentResultProof = null;
                errorDiv.classList.remove('hidden');
            }

            // Animate in
            setTimeout(() => {
                resultCard.classList.remove('hidden');
                resultCard.classList.add('show');
            }, 50);
        }

        function populateSuccessCard(proof) {
            const t = translations[currentLanguage];

            // Bag ID
            document.getElementById('resultBagId').textContent = proof.bagId;

            // Date
            const date = proof.date ? new Date(proof.date).toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-US') : '---';
            document.getElementById('resultDate').textContent = date;

            // Version with link
            const version = proof.version || 'Unknown';
            const firmwareLink = getFirmwareLink(version);
            const versionHtml = firmwareLink
                ? `<a href="${firmwareLink}" target="_blank" rel="noopener" class="text-specter-cyan hover:underline">${version}</a>`
                : `<span class="text-white">${version}</span>`;
            document.getElementById('resultVersion').innerHTML = versionHtml;

            // Packer with profile link
            const packer = proof.packer || 'Unknown';
            const packerHtml = PACKERS[packer]
                ? `<button onclick="showPackerModal('${packer}')" class="text-specter-cyan hover:underline font-semibold">${packer}</button>`
                : `<span class="text-white">${packer}</span>`;
            document.getElementById('resultPacker').innerHTML = packerHtml;

            // Proof Badge
            const proofBadgeContainer = document.getElementById('resultProofBadge');
            if (proof.status === 'verified') {
                proofBadgeContainer.innerHTML = `
                    <div class="flex items-center gap-3 p-4 bg-green-500/20 border border-green-500/30 rounded-xl">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="font-bold text-green-500">${t.timestamped} @${proof.blockHeight}</p>
                            <p class="text-sm text-specter-textMuted">${t.verifiedDescription}</p>
                        </div>
                    </div>
                `;
            } else {
                proofBadgeContainer.innerHTML = `
                    <div class="flex items-center gap-3 p-4 bg-yellow-500/20 border border-yellow-500/30 rounded-xl">
                        <svg class="w-8 h-8 text-yellow-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="font-bold text-yellow-500">${t.pending}</p>
                            <p class="text-sm text-specter-textMuted">${t.pendingDescription}</p>
                        </div>
                    </div>
                `;
            }

            // Setup action buttons
            document.getElementById('resultViewImage').onclick = () => {
                if (proof.imageUrl) showImageModal(proof.imageUrl);
            };

            document.getElementById('resultViewProof').onclick = () => {
                const index = allProofs.findIndex(p => p.bagId === proof.bagId);
                if (index !== -1) {
                    currentTimestampData = proof;
                    showTimestampModal(index);
                }
            };
        }

        // ===========================================
        // Initialize
        // ===========================================
        document.addEventListener('DOMContentLoaded', () => {
            updateLanguage();
            renderSuppliers();
            loadProofs();

            // Search input - Enter key triggers search
            const searchInput = document.getElementById('bagIdSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        verifyBag();
                    }
                });
            }

            // Search button - Click triggers search
            const verifyButton = document.getElementById('verifyBagButton');
            if (verifyButton) {
                verifyButton.addEventListener('click', verifyBag);
            }

            // Camera scan button - Click opens camera
            const cameraScanButton = document.getElementById('cameraScanButton');
            if (cameraScanButton) {
                cameraScanButton.addEventListener('click', openCameraScan);
            }

            // Camera scan modal backdrop close
            document.getElementById('cameraScanModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('cameraScanModal')) {
                    closeCameraScan();
                }
            });
        });
    </script>
</body>
</html>
